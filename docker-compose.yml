services:
  # WordPressサービス
  wordpress:
    image: wordpress:php${PHP_VERSION:-8.2}-${WP_SERVER:-apache}
    container_name: wp-wordpress
    restart: unless-stopped
    ports:
      - "${WP_PORT:-8080}:80"
    environment:
      # データベース接続設定
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_NAME: ${MYSQL_DATABASE:-wordpress}
      WORDPRESS_DB_USER: ${MYSQL_USER:-wordpress}
      WORDPRESS_DB_PASSWORD: ${MYSQL_PASSWORD:-wordpress_password}

      # WordPress環境設定
      WORDPRESS_DEBUG: ${WP_DEBUG:-1}
      WORDPRESS_CONFIG_EXTRA: |
        define('WP_DEBUG_LOG', ${WP_DEBUG_LOG:-1});
        define('WP_DEBUG_DISPLAY', ${WP_DEBUG_DISPLAY:-1});

        /* PHPメモリ制限 */
        define('WP_MEMORY_LIMIT', '256M');
        define('WP_MAX_MEMORY_LIMIT', '256M');
    volumes:
      # WordPressファイル全体を名前付きボリュームで共有（WP-CLIと共有）
      - wordpress-data:/var/www/html
      # wp-contentをホストにマウント（プラグイン・テーマ・アップロードファイルの永続化）
      - ./wordpress/wp-content:/var/www/html/wp-content
    depends_on:
      db:
        condition: service_healthy
    networks:
      - wp-network

  # データベースサービス（MySQL/MariaDB）
  db:
    image: ${DB_TYPE:-mysql}:${DB_VERSION:-8.0}
    container_name: wp-database
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE:-wordpress}
      MYSQL_USER: ${MYSQL_USER:-wordpress}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-wordpress_password}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_password}
    volumes:
      # データベースデータを名前付きボリュームで永続化
      - db-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root_password}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - wp-network

  # Nginxサービス（WP_SERVER=fpmの場合のみ起動）
  nginx:
    image: nginx:alpine
    container_name: wp-nginx
    restart: unless-stopped
    profiles:
      - nginx
    ports:
      - "${WP_PORT:-8080}:80"
    volumes:
      # Nginx設定ファイル
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # WordPressファイルへのアクセス（PHP-FPMと共有）
      - ./wordpress/wp-content:/var/www/html/wp-content
    depends_on:
      - wordpress
    networks:
      - wp-network

  # phpMyAdminサービス（PHPMYADMIN_ENABLED=trueの場合のみ起動）
  phpmyadmin:
    image: phpmyadmin:${PHPMYADMIN_VERSION:-latest}
    container_name: wp-phpmyadmin
    restart: unless-stopped
    profiles:
      - phpmyadmin
    ports:
      - "${PHPMYADMIN_PORT:-8081}:80"
    environment:
      PMA_HOST: db
      PMA_PORT: 3306
      PMA_USER: ${MYSQL_USER:-wordpress}
      PMA_PASSWORD: ${MYSQL_PASSWORD:-wordpress_password}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_password}
    depends_on:
      db:
        condition: service_healthy
    networks:
      - wp-network

  # WP-CLIサービス（WordPressコマンドラインツール）
  wpcli:
    image: wordpress:cli-php${PHP_VERSION:-8.2}
    container_name: wp-cli
    user: "33:33"  # www-dataユーザーとして実行（Debian版WordPressと互換性を保つ）
    profiles:
      - wpcli
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_NAME: ${MYSQL_DATABASE:-wordpress}
      WORDPRESS_DB_USER: ${MYSQL_USER:-wordpress}
      WORDPRESS_DB_PASSWORD: ${MYSQL_PASSWORD:-wordpress_password}
    volumes:
      # WordPressファイル全体を共有（wordpressコンテナと同じボリューム）
      - wordpress-data:/var/www/html
      # wp-contentをホストにマウント（wordpressコンテナと共有）
      - ./wordpress/wp-content:/var/www/html/wp-content
    depends_on:
      wordpress:
        condition: service_started
      db:
        condition: service_healthy
    networks:
      - wp-network
    # コマンド実行用のため、コンテナを起動し続ける
    command: tail -f /dev/null

# ネットワーク定義
networks:
  wp-network:
    driver: bridge

# ボリューム定義
volumes:
  db-data:
    driver: local
  wordpress-data:
    driver: local
